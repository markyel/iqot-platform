# Обновление логики списания средств

## Изменения

### Старая логика
- Средства списывались при одобрении заявки администратором
- Полная сумма списывалась сразу

### Новая логика
- Средства **замораживаются** при создании заявки
- Средства остаются **замороженными** при одобрении заявки
- Средства **списываются постепенно** - по мере выполнения каждой позиции
- **Позиция считается выполненной** когда получено **3 или более предложений** от поставщиков
- При отклонении заявки средства **размораживаются** и возвращаются пользователю

## Техническая реализация

### 1. Новая таблица `balance_charges`
Хранит информацию о списаниях по каждой позиции отдельно:
- `user_id` - пользователь
- `balance_hold_id` - связь с заморозкой
- `request_id` - заявка
- `external_request_item_id` - ID позиции во внешней БД
- `amount` - сумма списания за позицию
- `description` - описание списания

### 2. Новая модель `BalanceCharge`
Модель для работы с отдельными списаниями

### 3. Observer `ExternalRequestItemObserver`
Отслеживает изменения в позициях заявок во внешней БД:
- При обновлении поля `offers_count` проверяет достигнуто ли 3+ предложений
- Если да - вызывает списание средств за эту позицию

### 4. Обновленные методы в `BalanceHold`
- `chargeForItem($externalRequestItemId, $itemCost, $description)` - списать за конкретную позицию
- `getChargedAmount()` - получить сумму уже списанных средств
- `getRemainingAmount()` - получить остаток замороженных средств

### 5. Обновленная страница транзакций
Теперь отображает:
- Заморозка средств
- **Отдельные списания по каждой выполненной позиции** (новое)
- Разморозка средств (при отмене)
- Доступ к отчетам

## Установка

### 1. Запустить миграцию
```bash
php artisan migrate
```

Это создаст таблицу `balance_charges`.

### 2. Очистить кэш
```bash
php artisan cache:clear
php artisan config:clear
php artisan view:clear
```

## Как это работает

### Пример жизненного цикла заявки

1. **Пользователь создает заявку** с 5 позициями по 100₽ каждая = 500₽
   - Замораживается 500₽ на балансе

2. **Администратор одобряет заявку**
   - Средства остаются замороженными (500₽)
   - Заявка отправляется поставщикам

3. **Поставщики присылают предложения**
   - Позиция #1 получила 3 предложения → списывается 100₽ (остаток: 400₽ заморожено)
   - Позиция #2 получила 5 предложений → списывается 100₽ (остаток: 300₽ заморожено)
   - Позиция #3 получила 2 предложения → средства не списываются (остаток: 300₽ заморожено)
   - Позиция #4 получила 4 предложения → списывается 100₽ (остаток: 200₽ заморожено)
   - Позиция #5 получила 1 предложение → средства не списываются (остаток: 200₽ заморожено)

4. **Итог**
   - Списано: 300₽ (за 3 выполненные позиции)
   - Остаток замороженных: 200₽ (за 2 невыполненные позиции)

## История транзакций

Теперь в разделе "Детализация расходов" пользователь увидит:
```
01.01.2026 10:00  Заморозка     Заморозка средств на заявку #REQ-123        -500.00 ₽
01.01.2026 14:30  Списание      Списание за позицию #1 в заявке REQ-123     -100.00 ₽
01.01.2026 15:15  Списание      Списание за позицию #2 в заявке REQ-123     -100.00 ₽
02.01.2026 09:00  Списание      Списание за позицию #4 в заявке REQ-123     -100.00 ₽
```

## Обратная совместимость

Код поддерживает старые заявки:
- Если у заявки нет записей в `balance_charges`, используется старая логика
- Новые заявки автоматически используют новую логику

## Файлы изменены

1. `database/migrations/2026_01_16_000001_create_balance_charges_table.php` - новая миграция
2. `app/Models/BalanceCharge.php` - новая модель
3. `app/Models/BalanceHold.php` - добавлены методы для частичного списания
4. `app/Observers/ExternalRequestItemObserver.php` - новый Observer
5. `app/Providers/AppServiceProvider.php` - регистрация Observer
6. `app/Http/Controllers/Admin/RequestController.php` - убрано списание при одобрении
7. `app/Http/Controllers/TariffController.php` - обновлена логика транзакций
