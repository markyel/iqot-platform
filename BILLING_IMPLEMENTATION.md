# Реализация системы биллинга IQOT

## Обзор

Система биллинга реализована согласно документу **IQOT_Формулировки_счетов_v4.pdf** и включает:

1. **Счета на оплату** (Invoices) - выставление авансовых платежей
2. **Закрывающие документы** (Acts/УПД) - формирование актов за оказанные услуги
3. **Управление реквизитами** - хранение реквизитов получателя платежа
4. **Автоматическое начисление средств** - при оплате счета

## Структура базы данных

### 1. billing_settings
Хранит реквизиты исполнителя (ИП Маркелов Д.Е.)

**Поля:**
- `name` - Название (ИП Маркелов Д.Е.)
- `inn`, `kpp`, `ogrnip`, `ogrn` - Налоговые реквизиты
- `address` - Юридический адрес
- `bank_name`, `bank_bik`, `bank_corr_account`, `bank_account` - Банковские реквизиты
- `director_name`, `director_short`, `director_position` - Данные подписанта
- `registration_date` - Дата регистрации ИП

### 2. invoices
Счета на оплату (авансовые платежи)

**Поля:**
- `user_id` - Покупатель
- `number` - Номер счета (автоинкремент, начиная с 611054)
- `invoice_date` - Дата выставления
- `subtotal`, `vat_rate`, `vat_amount`, `total` - Суммы и НДС
- `status` - Статус: draft, sent, paid, cancelled
- `paid_at`, `sent_at`, `cancelled_at` - Даты событий

**Назначение платежа (фиксированное):**
```
Авансовый платёж за услуги информационного сервиса IQOT согласно Договору-оферте, размещённому на сайте iqot.ru
```

### 3. invoice_items
Позиции счета

**Поля:**
- `invoice_id` - Ссылка на счет
- `sort_order` - Порядок сортировки
- `name` - Наименование услуги
- `unit` - Единица измерения (шт, услуга)
- `quantity`, `price`, `sum` - Количество, цена, сумма

### 4. acts
Закрывающие документы (УПД)

**Поля:**
- `user_id` - Покупатель
- `number` - Номер акта/УПД
- `act_date` - Дата акта
- `period_year`, `period_month` - Отчетный период
- `subtotal`, `vat_rate`, `vat_amount`, `total` - Суммы
- `status` - Статус: draft, generated, sent, signed

**Правило формирования:** Акты формируются **ежемесячно** не позднее 10 числа следующего месяца.

### 5. act_items
Позиции актов

**Поля:**
- `act_id` - Ссылка на акт
- `type` - Тип услуги: subscription, price_monitoring, catalog_access
- `subscription_charge_id`, `balance_charge_id`, `report_access_id` - Связи с источниками списаний
- `name` - Наименование услуги (формируется автоматически)
- `quantity`, `price`, `sum` - Количество, цена, сумма

## Модели

### Invoice
**Методы:**
- `generateNumber()` - Генерация уникального номера счета
- `recalculate()` - Пересчет сумм на основе позиций
- `markAsPaid()` - Отметить как оплаченный + начислить средства на баланс
- `getTotalWordsAttribute()` - Сумма прописью

### Act
**Методы:**
- `generateNumber()` - Генерация номера акта
- `recalculate()` - Пересчет сумм
- `getPeriodNameAttribute()` - Название периода ("январь 2026")

### ActGenerationService
**Методы:**
- `generateForPeriod(User $user, int $year, int $month)` - Сформировать акт за период
- `generateForAllUsers(int $year, int $month)` - Сформировать акты для всех пользователей

## Логика формирования актов

Согласно документу **IQOT_Формулировки_счетов_v4.pdf**:

### 1. Абонентская плата
**Формулировка:**
```
Абонентская плата за тарифный план «[название]» информационного сервиса IQOT
за [месяц год] согласно Договору-оферте, размещённому на сайте iqot.ru
```

**Правило:** Включается в акт **в месяце списания** (списывается в начале периода)

**Источник данных:** `subscription_charges` таблица

### 2. Ценовой мониторинг
**Формулировка:**
```
Услуги ценового мониторинга информационного сервиса IQOT за [месяц год]
([N] позиций) согласно Договору-оферте, размещённому на сайте iqot.ru
```

**Правило:** Включается в акт **в месяце получения ≥3 КП** (после разморозки и списания)

**Источник данных:** `balance_charges` где `external_request_item_id` IS NOT NULL

### 3. Доступ к отчетам каталога
**Формулировка:**
```
Предоставление доступа к отчётам каталога информационного сервиса IQOT за [месяц год]
([M] отчётов) согласно Договору-оферте, размещённому на сайте iqot.ru
```

**Правило:** Включается в акт **в месяце покупки** (списание моментальное)

**Источник данных:** `report_accesses`

### Важно:
- **Заявки/отчеты в пределах лимита** НЕ включаются в акт отдельно (оплачены абонентской платой)
- **Заморозка средств** НЕ является списанием
- Если мониторинг не состоялся (<3 КП), средства размораживаются и в акт НЕ включаются

## Шаблоны документов

Шаблоны находятся в `ToDo/`:

1. **invoice.blade.html** - Шаблон счета на оплату
2. **upd.blade.html** - Шаблон УПД (Универсальный передаточный документ)

### Переменные для счета:
```php
$invoice = Invoice::with('items')->find($id);
$seller = BillingSettings::current();
$buyer = $invoice->user; // Реквизиты из профиля пользователя
```

### Переменные для УПД:
```php
$act = Act::with('items')->find($id);
$seller = BillingSettings::current();
$buyer = $act->user;

// Дополнительно:
$number = $act->number;
$date_long = "23 января 2026 г.";
$date_short = "23.01.2026";
$status = 1; // 1 - счет-фактура и акт, 2 - только акт
```

## Процесс работы

### 1. Пополнение баланса
1. Администратор выставляет счет пользователю через админку
2. Пользователь видит счет в личном кабинете
3. Пользователь оплачивает счет
4. Администратор отмечает счет как оплаченный
5. **Автоматически начисляются средства на баланс** пользователя

### 2. Использование услуг
1. Пользователь использует услуги (заявки, отчеты, абонплата)
2. Средства списываются/замораживаются согласно логике `BalanceHold`/`BalanceCharge`
3. Данные накапливаются в соответствующих таблицах

### 3. Формирование актов
1. **Ежемесячно** (не позднее 10 числа следующего месяца)
2. Запускается `ActGenerationService::generateForAllUsers($year, $month)`
3. Для каждого пользователя собираются все списания за месяц
4. Формируется акт с позициями согласно формулировкам
5. Акт переводится в статус `generated`

### 4. Отправка актов
1. Администратор просматривает сформированные акты
2. Генерирует PDF (УПД)
3. Отправляет пользователю
4. Отмечает как `sent` или `signed`

## Следующие шаги (TODO)

- [ ] Создать контроллер для управления реквизитами в админке
- [ ] Создать интерфейс управления реквизитами
- [ ] Создать контроллер для работы со счетами (создание, отметка как оплаченный, PDF)
- [ ] Создать интерфейс выставления счетов в админке
- [ ] Создать представления счета и УПД на основе макетов
- [ ] Создать интерфейс просмотра счетов и актов для пользователя
- [ ] Добавить автоматическое начисление средств при отметке счета как оплаченного (DONE в Invoice::markAsPaid())
- [ ] Настроить генерацию PDF через DomPDF или аналог
- [ ] Создать консольную команду для ежемесячного формирования актов
- [ ] Добавить отправку уведомлений при выставлении счета/акта

## Реквизиты по умолчанию

Вставлены в миграцию `create_billing_settings_table`:

```
ИП Маркелов Дмитрий Евгеньевич
ИНН: 771512090267
ОГРНИП: 324774600503025
Адрес: 127549, г. Москва, ш. Алтуфьевское, д. 62А, кв. 97
Банк: АО "ТИНЬКОФФ БАНК"
БИК: 044525974
К/с: 30101810145250000974
Р/с: (нужно указать реальный)
```

## НДС

Ставка НДС по умолчанию: **5%** (согласно макетам)

Расчет:
```php
$vat_amount = round($subtotal * 0.05, 2);
$total = $subtotal + $vat_amount;
```

## Интеграция с существующей системой

Система биллинга интегрирована с:

1. **BalanceCharge** - списания за выполненные позиции заявок
2. **SubscriptionCharge** - списания абонентской платы
3. **ReportAccess** - покупки отчетов из каталога
4. **User** - автоматическое пополнение баланса при оплате счета

## Безопасность

- Только администраторы могут управлять реквизитами
- Только администраторы могут выставлять счета
- Только администраторы могут отмечать счета как оплаченные
- Пользователи видят только свои документы
- Генерация PDF должна происходить на стороне сервера
